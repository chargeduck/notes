::: info
本文档来自于 [尚硅谷ElasticSearch](https://www.bilibili.com/video/BV1hh411D7sb) 

==参考文档==

1. [ElasticSearch8.X和JavaApi使用](https://juejin.cn/post/7147861385970450440#heading-18)
1. [Easy-Es简介](https://zhuanlan.zhihu.com/p/667894373)

:::

# 1. ElasticSearch入门

## 1. 下载安装

### 1. Windows下安装

1. [官网下载  https://www.elastic.co/cn/downloads/elasticsearch](https://www.elastic.co/cn/downloads/elasticsearch)

2. 安装

```shell
#windows 下 直接解压缩，
# 执行bin下边的 elasticSearch.bat
```

3. 运行成功之后`9300`为Es内部通信端口 `9200`为RestFul接口访问端口,浏览器访问[http://192.168.0.107:9200](http://192.168.0.107:9200), **<font color=red>看自己的控制台打印什么就访问什么地址</font>**

```shell
[2024-06-15T17:16:38,580][INFO ][o.e.t.TransportService   ] [ELEVEN] publish_address {127.0.0.1:9300}, bound_addresses {[::1]:9300}, {127.0.0.1:9300}
[2024-06-15T17:16:39,030][INFO ][o.e.h.AbstractHttpServerTransport] [ELEVEN] publish_address {192.168.0.107:9200}, bound_addresses {[::]:9200}
```

4. 因为我安装的是`8.14.1`版本，所以可能会出现一下问题，这种情况就需要访问[https://192.168.0.107:9200](https://192.168.0.107:9200)，提示不安全的话直接继续访问就行了

```shell
 received plaintext http traffic on an https channel, closing connection Netty4HttpChannel{localAddress=/192.168.0.107:9200, remoteAddress=/192.168.0.107:59900}
```

5. 高版本的`elasticSearch`访问后需要认证，默认的用户名为`elastic`密码为`changeme`，需要生成密码

```shell
# windows下加/d不用使用E:切换盘符
cd /d E:\ide\elastic-8.14.1\bin
# 生成密码
elasticsearch-reset-password -u elastic
# 输入信息
warning: ignoring JAVA_HOME=C:\Program Files\Java\jdk-21; using bundled JDK
This tool will reset the password of the [elastic] user to an autogenerated value.
The password will be printed in the console.
Please confirm that you would like to continue [y/N]y

# 生成的密码是这个
Password for the [elastic] user successfully reset.
New value: e7_j=hfoRxme10KcrQCn
```

还有一个链接可以改密码，[CSDN Elasticsearch如何设置密码](https://blog.csdn.net/u012069313/article/details/136163249)

6. 访问出现下边的数据，就成功了

```json
{
  "name" : "ELEVEN",
  "cluster_name" : "elasticsearch",
  "cluster_uuid" : "ncpM6LAXQ3WJkaBX-qBPjQ",
  "version" : {
    "number" : "8.14.1",
    "build_flavor" : "default",
    "build_type" : "zip",
    "build_hash" : "93a57a1a76f556d8aee6a90d1a95b06187501310",
    "build_date" : "2024-06-10T23:35:17.114581191Z",
    "build_snapshot" : false,
    "lucene_version" : "9.10.0",
    "minimum_wire_compatibility_version" : "7.17.0",
    "minimum_index_compatibility_version" : "7.0.0"
  },
  "tagline" : "You Know, for Search"
}
```

### x. 遇见的问题

1. 打不开9200端口

> 使用8.X版本的elasticSearch，需要使用<font color=red>https://</font>协议进行访问

```shell
received plaintext http traffic on an https channel, closing connection Netty4HttpChannel{localAddress=/192.168.0.107:9200, remoteAddress=/192.168.0.107:59900}
```

2. 需要账号密码

```shell
# 给默认账号elastic生成密码
elasticsearch-reset-password -u elastic
```

3. 运行闪退

> 修改`config/jvm.options`文件

```shell
-Xms1g
-Xmx1g
```

### 2. 倒排索引

1. 正排索引

> 就如同mysql等关系型数据库一样，存在以下数据库，通过id关联内容

| id   | content      |
| ---- | ------------ |
| 1    | My name is 1 |
| 2    | name is You  |

2. 倒排索引

> 通过关键字，告诉当前关键字在哪些文档里

| keywords | id   |
| -------- | ---- |
| name     | 1,2  |
| You      | 2    |

## 2. 基础操作

### 1. 索引操作

#### 1. 创建索引 

- 使用ApiPost发送下列请求

```shell
PUT https://localhost:9200/shopping
```

- 如果提示`missing authentication credentials for REST request [/shopping]`,那就在apipost的认证里选择Basic auth，填上刚才的账号密码
- 或者在`https://localhost:9200`浏览器里边看控制台的header

- 提示下列信息就代表创建完成

```json
{
	"acknowledged": true,
	"shards_acknowledged": true,
	"index": "shopping"
}
```

#### 2. 获取索引

- 请求地址

```shell
GET https://localhost:9200/shopping
```

- 响应示例

```json
{
	"shopping": {
		"aliases": {},
		"mappings": {},
		"settings": {
			"index": {
				"routing": {
					"allocation": {
						"include": {
							"_tier_preference": "data_content"
						}
					}
				},
				"number_of_shards": "1",
				"provided_name": "shopping",
				"creation_date": "1718445301164",
				"number_of_replicas": "1",
				"uuid": "faG0UdjXRPm67kU3GuQoAA",
				"version": {
					"created": "8505000"
				}
			}
		}
	}
}
```

#### 3. 获取所有的索引

- 请求地址

```shell
GET http://localhost:9200/_cat/indices?v
```

- 响应示例

```shell
health status index    uuid                   pri rep docs.count docs.deleted store.size pri.store.size dataset.size
yellow open   shopping faG0UdjXRPm67kU3GuQoAA   1   1          0            0       249b           249b         249b
```

#### 4. 删除索引

- 请求地址

```shell
DELETE https://localhost:9200/shopping
```

- 响应示例

```json
{
	"acknowledged": true
}
```

### 2. 文档操作

#### 1. 创建文档

- 请求地址

```http
POST http://localhost:9200/shopping/_doc
```

- 请求参数

```json
{
    "title": "ROG",
    "ccategory":"笔记本",
    "price": 8999
}
```

- 响应示例

```json
{
	"_index": "shopping",
	"_id": "K2P8HpABFD9qZQar6Gjp",
	"_version": 1,
	"result": "created",
	"_shards": {
		"total": 2,
		"successful": 1,
		"failed": 0
	},
	"_seq_no": 1,
	"_primary_term": 2
}
```

#### 2. 创建自定义id的文档

- 请求地址

```http
POST http://localhost:9200/shopping/_doc/1001
```

- 请求参数

```json
{
    "title":"机械革命蛟龙16K",
    "category": "笔记本电脑",
    "price": 4999
}
```

- 响应示例

```json
{
	"_index": "shopping",
	"_id": "1001",
	"_version": 1,
	"result": "created",
	"_shards": {
		"total": 2,
		"successful": 1,
		"failed": 0
	},
	"_seq_no": 2,
	"_primary_term": 2
}
```

#### 3. 获取文档数据

- 请求地址

```http
GET https://localhost:9200/shopping/_doc/1001
```

- 响应示例

```json
{
	"_index": "shopping",
	"_id": "1001",
	"_version": 1,
	"_seq_no": 2,
	"_primary_term": 2,
	"found": true,
	"_source": {
		"title": "机械革命蛟龙16K",
		"category": "笔记本电脑",
		"price": 4999
	}
}
```

#### 4. 查询索引下所有数据

- 请求地址

```http
GET https://localhost:9200/shopping/_search
```

#### 5. 全量修改

- 请求地址

```http
PUT https://localhost:9200/shopping/_doc/1001
```

- 变更json

```json
{
    "test": "all edit"
}
```



#### 6. 局部更新

- 请求地址

```json
POST https://localhost:9200/shopping/_update/1001
```

- 请求示例

```json
{
    "doc": {
        “title": "局部修改"
    }
}
```

#### 7. 删除文档

- 请求地址

```http
DELETE https://localhost:9200/shopping/_doc/1001
```

### 3. 查询操作

#### 1. 请求参数请求

- 请求地址

```http
GET https://localhost:9200/shopping/_search?q=category:小米
```

- 响应示例

```json
{
	"took": 25,
	"timed_out": false,
	"_shards": {
		"total": 1,
		"successful": 1,
		"skipped": 0,
		"failed": 0
	},
	"hits": {
		"total": {
			"value": 1,
			"relation": "eq"
		},
		"max_score": 0.5753642,
		"hits": [
			{
				"_index": "shopping",
				"_id": "1tRoG5AB_4Fx2pkCl72Q",
				"_score": 0.5753642,
				"_source": {
					"title": "小米手机",
					"category": "小米",
					"price": 1999,
					"domain": "http://xiaomi.com"
				}
			}
		]
	}
}
```

#### 2. 请求体查询

- 请求地址

```http
GET https://localhost:9200/shopping/_search
```

- 请求参数

```json
{
	"query": {
		"match": {
			"category": "小米"
		}
	}
}
```

#### 3. 全量查询

- 请求地址

```http
GET https://localhost:9200/shopping/_search
```

- 请求参数

```json
{
	"query": {
		"match_all": {
			
		}
	}
}
```

#### 4. 分页查询

- 请求地址

```http
GET https://localhost:9200/shopping/_search
```

- 请求参数

```json
{
	"query": {
		"match_all": {
			
		}
	},
    "from": 1,
    "size": 2
}
```

#### 5. 筛选属性

> 通过添加`_source`数组来删选展示出来的字段

- 请求地址

```http
GET https://localhost:9200/shopping/_search
```

- 请求参数

```json
{
	"query": {
		"match_all": {
			
		}
	},
    "from": 1,
    "size": 2,
    "_source": [
        "title"
    ]
}
```

- 响应示例

```json
{
	"took": 8,
	"timed_out": false,
	"_shards": {
		"total": 1,
		"successful": 1,
		"skipped": 0,
		"failed": 0
	},
	"hits": {
		"total": {
			"value": 2,
			"relation": "eq"
		},
		"max_score": 1,
		"hits": [
			{
				"_index": "shopping",
				"_id": "1tRoG5AB_4Fx2pkCl72Q",
				"_score": 1,
				"_source": {
					"title": "小米手机"
				}
			},
			{
				"_index": "shopping",
				"_id": "K2P8HpABFD9qZQar6Gjp",
				"_score": 1,
				"_source": {
					"title": "ROG"
				}
			}
		]
	}
}
```

#### 6. 排序

- 查询参数

```json
{
	"query": {
		"match_all": {
			
		}
	},
    "sort": {
        "price": {
            "order": "asc"
        }
    }
  
}
```

#### 7. 多条件查询

- and查询

> 查询 `category`是小米且`price`=1999的数据, **<font color=red>关键字"must"</font>**

```json
{
	"query": {
		"bool": {
			"must": [
				{
					"match": {
						"category": "小米"
					}
				},
				{
					"match": {
						"price": 1999
					}
				}
			]
		}
	}
}
```

- or查询

> **<font color=red>关键字should</font>**,查询小米或者是华为的分类

```json
{
	"query": {
		"bool": {
			"should": [
				{
					"match": {
						"category": "小米"
					}
				},
				{
					"match": {
						"category": "华为"
					}
				}
			]
		}
	}
}
```

- 范围查询

> 查询price > 5000的数据

```json
{
	"query": {
		"bool": {
			"filter": {
				"range": {
					"price": {
						"gt": 5000
					}
				}
			}
		}
	}
}
```

- 完全匹配

> 使用`match_phrase`完全匹配查询

```json
{
    "query": {
        "match_phrase": {
            "category": "小米"
        }
    }
}
```

- 高亮展示

```json
{
    "query": {
        "match": {
            "category": "小"
        }
    },
    "highlight": {
        "fields": {
            "category": {

            }
        }
    }
}
```

- 聚合操作

| 关键字 | 描述               |
| ------ | ------------------ |
| terms  | 分组相当于group by |
| avg    | 平均值             |

```json
{
    "aggs": {
        "price_group": {
            // 分组操作
            "terms": {
                "field": "price"
            }
        }
    }
}
```

#### 8. 映射

1. 创建索引 `user`
2. 创建索引

```http
POST https://localhost:9200/user/_mapping
```

```json
{
    "properties": {
        "name": {
            "type": "text",
            "index": true
        },
        "sex": {
            "type": "keyword",
            "index": true
        },
        "phone": {
            "type": "keyword",
            "index": false
        }
    }
}
```

# 2. Java操作

> 原视频使用的是`High Level Rest Client`,这里我是用了最新的版本

## 1. 引入依赖

> 官方先后弃用了`Transport Client`和`High Level Client`,详情参考[ElasticSearch 8.x 弃用了 High Level REST Client，移除了 Java Transport Client，推荐使用 Elasticsearch Java API](https://blog.csdn.net/qq_19283249/article/details/135352522)

```xml
<dependencies>
    <dependency>
        <groupId>junit</groupId>
        <artifactId>junit</artifactId>
        <version>3.8.1</version>
        <scope>test</scope>
    </dependency>
    <dependency>
        <groupId>co.elastic.clients</groupId>
        <artifactId>elasticsearch-java</artifactId>
        <version>8.14.1</version>
    </dependency>
    <dependency>
        <groupId>com.fasterxml.jackson.core</groupId>
        <artifactId>jackson-databind</artifactId>
        <version>2.13.4.1</version>
    </dependency>
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <version>1.18.22</version>
        <scope>provided</scope>
    </dependency>
</dependencies>
```

## 2. 创建ES链接

```java
@Slf4j
public class ESClient {


    /**
     * 初始化客户端
     *
     * @return
     */
    public static ElasticsearchClient initClient() {
        String hostname = "127.0.0.1";
        int port = 9200;
        String username = "elastic";
        String password = "e7_j=hfoRxme10KcrQCn";
        // 基本的用户名密码认证
        BasicCredentialsProvider basicCredentialsProvider = new BasicCredentialsProvider();
        basicCredentialsProvider.setCredentials(AuthScope.ANY, new UsernamePasswordCredentials(username, password));
        RestClientBuilder restClientBuilder = RestClient.builder(new HttpHost(hostname, port, "https"));
        restClientBuilder.setHttpClientConfigCallback(httpAsyncClientBuilder ->
                {
                    try {
                        return httpAsyncClientBuilder.setDefaultCredentialsProvider(basicCredentialsProvider)
                                .setSSLContext(SSLContextBuilder.create()
                                        .loadTrustMaterial((chain, authType) -> true)
                                        .build());
                    } catch (Exception e) {
                        throw new RuntimeException(e);
                    }
                }
        );
        RestClient restClient = restClientBuilder.build();
        ElasticsearchTransport transport = new RestClientTransport(restClient, new JacksonJsonpMapper());
        return new ElasticsearchClient(transport);
    }

}
```

- 创建文档实体类

```java
@Data
@NoArgsConstructor
@AllArgsConstructor
public class User {
    private String name;

    private Integer age;

    private String sex;
}

```

## 3. 操作索引

```java
@Slf4j
public class EsClientIndexTest {
    public static void main(String[] args) throws IOException {
        // 创建ES客户端
        ElasticsearchClient esClient = ESClient.initClient();
        log.info("客户端创建成功");
        System.out.println(esClient);
        String indexName = "java_api2";
        GsonBuilder gsonBuilder = new GsonBuilder();
        gsonBuilder.setPrettyPrinting();
        Gson gson = gsonBuilder.create();
        // 创建索引
        //boolean indexAck = createIndex(esClient, "java_api2", "java_api_alias2");
        //log.info("索引创建结果 {}", indexAck);
        //GetIndexResponse allIndexResp = queryAllIndex(esClient);
        //log.info("当前所有的index");
        //printIndexResp(allIndexResp);
        //GetIndexResponse indexResponse = queryIndex(esClient, Collections.singletonList(indexName));
        //log.info("当前索引{}数据 \n {}", indexName, gson.toJson(indexResponse));
        //printIndexResp(indexResponse);
        //GetIndexResponse indexResponse1 = queryIndex(esClient, indexName, "java_api");
        //printIndexResp(indexResponse1);
        DeleteIndexResponse deleteIndexResponse = delIndex(esClient, indexName);
        log.info("删除{}结果{}", indexName, deleteIndexResponse);

    }

    private static void printIndexResp(GetIndexResponse response) {
        Map<String, IndexState> result = response.result();
        log.info("\n===========================");
        result.forEach((k, v) -> {
            log.info("\nindex:{}\nalias: {}\nmapping: {}\nsettings: {}",
                    k,
                    v.aliases(),
                    v.mappings(),
                    v.settings());
        });
        log.info("\n===========================");
    }

    /**
     * 创还能索引
     *
     * @param client    es客户端
     * @param indexName 索引名称
     * @param alias     索引别名
     * @return Boolean         创建结果
     * @throws IOException
     */

    private static boolean createIndex(ElasticsearchClient client, String indexName, String alias) throws IOException {
        CreateIndexResponse indexResponse = client.indices()
                .create(
                        new CreateIndexRequest.Builder()
                                .index(indexName)
                                .aliases(alias,
                                        new Alias.Builder().isWriteIndex(true).build())
                                .build()
                );
        if (indexResponse.acknowledged()) {
            log.info("创建索引成功");
        } else {
            log.info("创建索引失败");
        }
        return indexResponse.acknowledged();
    }

    /**
     * 查询数据
     * @param client            es客户端
     * @param indexName         要查询的索引集合
     * @return
     * @throws IOException
     */
    private static GetIndexResponse queryIndex(ElasticsearchClient client, List<String> indexName) throws IOException {
        GetIndexResponse getIndexResponse = client.indices()
                .get(new GetIndexRequest.Builder()
                        .index(indexName)
                        .build()
                );

        return getIndexResponse;
    }

    private static GetIndexResponse queryIndex(ElasticsearchClient client, String indexName, String... indies) throws IOException {
        return client.indices()
                .get(new GetIndexRequest.Builder()
                        .index(indexName, indies)
                        .build()
                );
    }

    /**
     * 查询所有的索引
     *
     * @param client es客户端
     * @return GetIndexResponse 索引响应
     * @throws IOException
     */
    private static GetIndexResponse queryAllIndex(ElasticsearchClient client) throws IOException {
        return client.indices()
                .get(new GetIndexRequest.Builder()
                        .index("*")
                        .build());
    }

    private static DeleteIndexResponse delIndex(ElasticsearchClient client, String indexName) throws IOException {
        DeleteIndexResponse delete = client.indices()
                .delete(new DeleteIndexRequest.Builder()
                        .index(indexName)
                        .build()
                );
        return delete;
    }
}

```

## 4. 操作文档

```java
@Slf4j
public class ESClientDocTest {

    private static Gson gson;

    static {
        GsonBuilder gsonBuilder = new GsonBuilder();
        gsonBuilder.setPrettyPrinting();
        gson = gsonBuilder.create();
    }

    public static void main(String[] args) throws IOException {
        ElasticsearchClient client = ESClient.initClient();
        String randomId = RandomUtil.randomString("0123456789", 4);
        String indexName = "user";
        IndexResponse createIndexResp = createDoc(client, indexName, randomId);
        log.info("当前创建doc的结果{}", createIndexResp);
        GetResponse<User> userGetResponse = queryDoc(client, indexName, randomId);
        log.info("当前doc结果{}", userGetResponse);
        UpdateResponse updateResponse = editeDoc(client, indexName, randomId);
        log.info("当前更新doc的结果{}", updateResponse);
        GetResponse<User> afterResp = queryDoc(client, indexName, randomId);
        log.info("当前doc结果{}", afterResp);
        DeleteResponse deleteResponse = delDoc(client, indexName, randomId);
        log.info("当前删除doc的结果{}", deleteResponse);
        existDoc(client, indexName, randomId);
        BulkResponse docBatch = createDocBatch(client, indexName);
        log.info("当前批量插入doc的结果 {}", docBatch);
        List<String> insertBatchIds = docBatch.items().stream()
                .map(BulkResponseItem::id)
                .collect(Collectors.toList());
        BulkResponse bulkResponse = delDocBatch(client, indexName, insertBatchIds);
        log.info("当前批量删除doc的结果 {}", bulkResponse);

    }

    /**
     * 批量创建文档
     * @param client
     * @param indexName
     * @throws IOException
     */
    public static BulkResponse createDocBatch(ElasticsearchClient client, String indexName) throws IOException {
        BulkRequest.Builder builder = new BulkRequest.Builder();
        for (int i = 0; i < 4; i++) {
            builder.operations(op -> op.index(
                    idx -> idx.index(indexName)
                            .id(String.valueOf(RandomUtil.randomInt(1000,9999)))
                            .document(randomUser())
            ));
        }
        BulkRequest bulkRequest = builder.build();

        return client.bulk(bulkRequest);
    }

    /**
     * 批量删除
     * @param client
     * @param indies
     * @return
     * @throws IOException
     */
    public static BulkResponse delDocBatch(ElasticsearchClient client, String indexName, List<String> indies) throws IOException {
        BulkRequest.Builder builder = new BulkRequest.Builder();
        indies.forEach(item ->
                builder.operations(op -> op.delete(del -> del.id(item).index(indexName)))
        );
        BulkRequest bulkRequest = builder.build();
        return client.bulk(bulkRequest);
    }
    /**
     * 创建文档
     *
     * @param client    客户端链接
     * @param indexName 索引名称
     * @param id        id
     * @return
     * @throws IOException
     */
    private static IndexResponse createDoc(ElasticsearchClient client, String indexName, String id) throws IOException {
        //IndexRequest<Object> doc = new IndexRequest.Builder<>()
        //        .document(randomUser())
        //        .index(indexName)
        //        .id(id)
        //        .build();
        //return client.index(doc);
        return client.index(i -> i.index(indexName).document(randomUser()).id(id));
    }

    private static DeleteResponse delDoc(ElasticsearchClient client, String indexName, String id) throws IOException {
        //DeleteRequest request = new DeleteRequest.Builder()
        //        .index(indexName)
        //        .id(id)
        //        .build();
        //return client.delete(request);
        return client.delete(d -> d.id(id).index(indexName)
        );
    }

    private static UpdateResponse editeDoc(ElasticsearchClient client, String indexName, String id) throws IOException {
        //UpdateRequest updateDoc = new UpdateRequest.Builder<>()
        //        .index(indexName)
        //        .id(id)
        //        .doc(randomUser())
        //        .build();
        //return client.update(updateDoc, User.class);
        return client.update(u -> u.index(indexName)
                        .doc(randomUser())
                        .id(id),
                User.class
        );

    }

    private static GetResponse<User> queryDoc(ElasticsearchClient client, String indexName, String id) throws IOException {
        //GetRequest request = new GetRequest.Builder()
        //        .index(indexName)
        //        .id(id)
        //        .build();
        //return client.get(request, User.class);
        return client.get(g -> g.index(indexName)
                        .id(id)
                , User.class);
    }

    private static void existDoc(ElasticsearchClient client, String indexName, String id) throws IOException {

        // 判断文档是否存在
        BooleanResponse booleanResponse = client.exists(s -> s.index(indexName).id(id));
        log.info("判断Document是否存在:{}", booleanResponse);
        log.info("判断Document是否存在:{}", booleanResponse.value());
    }

    private static User randomUser() {
        return new User(
                RandomUtil.randomString(RandomUtil.BASE_CHAR, 8),
                RandomUtil.randomInt(0, 140),
                RandomUtil.randomString("男女", 1)
        );
    }
}

```

## 5. 查询操作

```java
@Slf4j
public class EsClientSearchTest {

    private static ElasticsearchClient client = ESClient.initClient();
    private String indexName = "user";

    /**
     * 条件查询
     */
    @Test
    public void searchOne() throws IOException {

        String searchText = "女";
        SearchResponse<User> searchResponse = client.search(s -> s
                        // 我们要搜索的索引的名称
                        .index(indexName)
                        // 搜索请求的查询部分（搜索请求也可以有其他组件，如聚合）
                        .query(q -> q
                                // 在众多可用的查询变体中选择一个。我们在这里选择匹配查询（全文搜索）
                                .match(t -> t
                                        // name配置匹配查询：我们在字段中搜索一个词
                                        .field("sex")
                                        .query(searchText)
                                )
                        ),
                // 匹配文档的目标类
                User.class
        );
        printHits(searchResponse);
    }

    private <T> void printHits(SearchResponse<T> searchResponse) {
        HitsMetadata<T> hits = searchResponse.hits();
        TotalHits total = hits.total();
        log.info("total {}", total);
        printHits(hits.hits());
    }

    private <T> void printHits(List<Hit<T>> hitsList) {
        GsonBuilder gsonBuilder = new GsonBuilder();
        gsonBuilder.setPrettyPrinting();
        Gson gson = gsonBuilder.create();
        for (Hit<T> userHit : hitsList) {
            T source = userHit.source();
            log.info("\nhit source:\n{}\n", gson.toJson(source));

        }
    }

    @Test
    public void searchTwo() throws IOException {
        String searchText = "男";
        int maxAge = 100;
        Query bySex = MatchQuery.of(m -> m.field("sex").query(searchText))
                ._toQuery();
        Query ageQuery = RangeQuery.of(m -> m.field("age")
                        .gte(JsonData.of(maxAge)))
                ._toQuery();
        SearchResponse<User> searchResponse =
                client.search(s ->
                        s.index(indexName)
                                .query(q -> q.bool(b ->
                                                b.must(bySex)
                                                        .must(ageQuery)
                                        )
                                ), User.class);
        printHits(searchResponse);
    }

    @Test
    public void templateSearch() throws IOException {
        String scriptId = "query-script";
        client.putScript(script -> script
                .id(scriptId)
                .script(s -> s.lang(ScriptLanguage.Mustache)
                        .source("{\"query\":{\"match\":{\"{{field}}\":\"{{value}}\"}}}"))
        );
        String field = "sex";
        String value = "男";
        SearchTemplateResponse<User> searchTemplateResponse = client.searchTemplate(s ->
                        s.index(indexName)
                                // 模板脚本的id
                                .id(scriptId)
                                .params("field", JsonData.of(field))
                                .params("value", JsonData.of(value))
                ,
                User.class);
        printHits(searchTemplateResponse.hits().hits());
    }

    /**
     * 分页和排序查询
     */
    @Test
    public void paginationAndOrder() throws IOException {
        int maxAge = 100;
        Query ageQuery = RangeQuery.of(r -> r.field("age").gte(JsonData.of(maxAge)))
                ._toQuery();
        SearchResponse<User> searchResponse = client.search(s -> s.index(indexName)
                        .query(q -> q.bool(b -> b.must(ageQuery)))
                        // 查询第一页，10条，按照age倒序
                        .from(0)
                        .size(10)
                        .sort(f -> f.field(
                                obj -> obj.field("age")
                                        .order(SortOrder.Desc)
                        ))
                , User.class);
        printHits(searchResponse);

    }

    /**
     * 展示部分字段
     *
     * @throws IOException
     */
    @Test
    public void filterField() throws IOException {
        SearchResponse<User> searchResponse = client.search(s ->
                        s.index(indexName)
                                .query(q -> q.matchAll(m -> m))
                                .sort(st -> st.field(obj -> obj.field("age").order(SortOrder.Desc)))
                                .source(source -> source.filter(f -> f.includes("name", "age")))
                , User.class);
        printHits(searchResponse);
    }

    /**
     * 模糊查询
     */
    @Test
    public void fuzzyQuerySearch() throws IOException {
        SearchResponse<User> searchResponse = client.search(s ->
                        s.index(indexName)
                                .query(q -> q.fuzzy(
                                        fz ->
                                                // 模糊查询的属性
                                                fz.field("name")
                                                        // 模糊查询的值
                                                        .value("zz")
                                                        // 与短剑次有误差的字数, 可选 0 1 2
                                                        .fuzziness("2")
                                ))
                                .source(source -> source.filter(
                                        f -> f.includes("name", "age")
                                ))
                , User.class);
        printHits(searchResponse);
    }

    @Test
    public void highlightSear() throws IOException {
        SearchResponse<User> searchResponse = client.search(s -> s
                        .index(indexName)
                        .query(q -> q
                                .term(t -> t
                                        .field("name")
                                        .value("xngawjvv"))
                        )
                        .highlight(h -> h
                                .fields("name", f -> f
                                        .preTags("<font color='red'>")
                                        .postTags("</font>")))
                        .source(source -> source
                                .filter(f -> f
                                        .includes("name", "age")
                                        .excludes(""))),
                User.class
        );
        List<Hit<User>> hits = searchResponse.hits().hits();
        for (Hit<User> hit : hits) {
            hit.highlight().forEach((k,v) -> {
                log.info("{},{}", k, v);
            });
        }
    }
}

```

# 3. Easy-Es

> [Easy-Es官网](https://www.easy-es.cn/), Es原生的javaapi属实难用，所以就有大佬写了这个，用类似Mysql的语法，和使用MyabtisPlus一样。一法通万法通

## 1. 语法对比

| Mysql          | Easy Es          | ES java api                                                  |
| -------------- | ---------------- | ------------------------------------------------------------ |
| and            | and              | must                                                         |
| or             | or               | should                                                       |
| =              | eq               | term                                                         |
| !=             | ne               | boolQueryBuilder.mustNot(queryBuilder)                       |
| >              | gt               | QueryBuilder.rangeQuery('field').gt()                        |
| >=             | ge               | .rangeQuery('field').gte()                                   |
| <              | lt               | .rangeQuery('field').lt()                                    |
| <=             | le               | .rangeQuery('field').lte()                                   |
| like '%field%' | like             | QueryBuilders.wildcardQuery(field, value)                    |
| not like       | notLike          | must not wildcardQuery(field,value)                          |
| like '%field'  | likeLeft         | QueryBuilders.wildcardQuery(field,*value)                    |
| like 'field%'  | likeRight        | QueryBuilders.wildcardQuery(field,value*)                    |
| between        | between          | QueryBuilders.rangeQuery(es field').from(xx).to(xx)          |
| notBetween     | notBetween       | must not QueryBuilders.rangeQuery(es field').from(xx).to(xx) |
| is null        | isNull           | must not QueryBuilders.existsQuery(field)                    |
| is not null    | isNotNull        | QueryBuilders.existsQuery(field)                             |
| in             | in               | QueryBuilders.termsQuery('xx es field", xx)                  |
| not in         | notIn            | must not QueryBuilders.termsQuery("xx es field", xx)         |
| group by       | groupBy          | AggregationBuilders.terms()                                  |
| order by       | orderBy          | fieldSortBuilder.order(ASC/DESC)                             |
| min            | min              | AggregationBuilders.min                                      |
| max            | max              | AggregationBuilders.max                                      |
| avg            | avg              | AggregationBuilders.avg                                      |
| sum            | sum              | AggregationBuilders.sum                                      |
| -              | match            | matchQuery                                                   |
| -              | matchPhrase      | QueryBuilders.matchPhraseQuery                               |
| -              | matchPrefix      | QueryBuilders.matchPhrasePrefixQuery                         |
| -              | queryStringQuery | QueryBuilders.queryStringQuery                               |
| select *       | matchAllQuery    | QueryBuilders.matchAllQuery                                  |
| -              | hifhLight        | HighlightBuilder.Field                                       |
| ...            | ...              | ..                                                           |



## 2. 引入依赖

```xml
<parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-parent</artifactId>
    <version>2.3.3.RELEASE</version>
    <relativePath/> <!-- lookup parent from repository -->
</parent>
<dependencies>
    <dependency>
        <groupId>junit</groupId>
        <artifactId>junit</artifactId>
        <version>3.8.1</version>
        <scope>test</scope>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
        <!--排除springboot再带的es版本依赖，或者是升级springboot到2.5.5-->
        <exclusions>
            <exclusion>
                <groupId>org.elasticsearch.client</groupId>
                <artifactId>elasticsearch-rest-high-level-client</artifactId>
            </exclusion>
            <exclusion>
                <groupId>org.elasticsearch.client</groupId>
                <artifactId>elasticsearch-rest-client</artifactId>
            </exclusion>
            <exclusion>
                <groupId>org.elasticsearch</groupId>
                <artifactId>elasticsearch</artifactId>
            </exclusion>
        </exclusions>
    </dependency>
    <dependency>
        <groupId>org.dromara.easy-es</groupId>
        <artifactId>easy-es-boot-starter</artifactId>
        <version>2.0.0</version>
    </dependency>
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
    </dependency>
    <dependency>
        <groupId>org.slf4j</groupId>
        <artifactId>slf4j-log4j12</artifactId>
    </dependency>
    <dependency>
        <groupId>cn.hutool</groupId>
        <artifactId>hutool-all</artifactId>
        <version>5.8.27</version>
    </dependency>
</dependencies>
```

## 3. 添加配置信息

> 完整配置参考[https://www.easy-es.cn/pages/eddebb/](https://www.easy-es.cn/pages/eddebb/)

```yaml
easy-es:
  # es地址、账号密码
  address: 192.168.244.11:9200
  username: elastic
  password: e7_j=hfoRxme10KcrQCn
  keep-alive-millis: 30000 # 心跳策略时间 单位:ms
  connect-timeout: 5000 # 连接超时时间 单位:ms
  socket-timeout: 600000 # 通信超时时间 单位:ms
  request-timeout: 5000 # 请求超时时间 单位:ms
  connection-request-timeout: 5000 # 连接请求超时时间 单位:ms
  max-conn-total: 100 # 最大连接数 单位:个
  max-conn-per-route: 100 # 最大连接路由数 单位:个
  global-config:
    i-kun-mode: true # 是否开启小黑子模式,默认关闭, 开启后日志将更有趣,提升编码乐趣,仅供娱乐,切勿用于其它任何用途
```

## 4. 创建启动类

```java
@SpringBootApplication
// 添加注解标注Es的Mapper位置
@EsMapperScan("net.lesscoding.es.mapper")
public class EasyEsApp {
    public static void main(String[] args) {
        SpringApplication.run(EasyEsApp.class, args);
    }
}
```

## 5. 创建文档类

```java
@Data
// 标注es的index
@IndexName("user")
public class User {
    private String name;

    private Integer age;

    @HighLight
    private String sex;
}
```

## 6. 创建mapper

```java
public interface EsUserMapper extends BaseEsMapper<EsUser> {
}
```

## 7. 测试

```java
@RestController
@RequestMapping("/esUser")
public class EsUserController {

    @Autowired
    private EsUserMapper esUserMapper;

    @PostMapping("/create")
    public Boolean createIndex() {
        Boolean esUser = esUserMapper.existsIndex("es_user");
        if (!esUser) {
            return esUserMapper.createIndex();
        } else {
            return esUser;
        }
    }

    @PostMapping("/save")
    public Integer save() {
        EsUser user = new EsUser();
        user.setAge(RandomUtil.randomInt(0, 100));
        user.setName(RandomUtil.randomString(RandomUtil.BASE_CHAR, 4));
        user.setSex(RandomUtil.randomString("男女", 1));
        user.setId(RandomUtil.randomString("0123456789", 4));
        //EsUser queryUser = esUserMapper.selectById(user.getId());
        //if (queryUser == null) {
        //    return esUserMapper.updateById(user);
        //} else {
        //    return esUserMapper.insert(user);
        //}
        return esUserMapper.insert(user);
    }

    @GetMapping("/search")
    public List<EsUser> search(String name, String age) {
        return esUserMapper.selectList(EsWrappers.lambdaQuery(EsUser.class)
                .like(EsUser::getName, name)
                .lt(EsUser::getAge, age)
        );
    }

}
```

